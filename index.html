<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººåŒ–ç²¾æº–ä¿å¥æˆ°ç•¥æŒ‡å—</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d9488">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7;
            color: #4a4a4a;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .timeline-line {
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e2e8f0;
            z-index: 0;
        }

        .step-card { transition: all 0.3s ease; }
        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <header class="bg-white shadow-sm border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-start sm:items-center flex-col sm:flex-row gap-4">
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">
                    <i class="fa-solid fa-dna text-teal-600 mr-2"></i>ã€çµ‚æ¥µå®Œå…¨é«”ã€‘æŠ—è…«ç˜¤èˆ‡ä»£è¬é˜²è­·ä¸€é€±èª²è¡¨
                </h1>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div id="today-badge" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg text-sm font-bold border border-indigo-100 flex items-center shadow-sm whitespace-nowrap">
                        <i class="fa-regular fa-calendar-check mr-2"></i>ç³»çµ±è¼‰å…¥ä¸­...
                    </div>
                    <button onclick="enableSmartNotifications()" id="notify-btn" class="bg-teal-50 text-teal-700 px-4 py-2 rounded-lg text-sm font-bold border border-teal-100 flex items-center shadow-sm hover:bg-teal-100 transition whitespace-nowrap">
                        <i class="fa-regular fa-bell mr-2"></i>é–‹å•Ÿ 30 åˆ†é˜å‰æé†’
                    </button>
                </div>
            </div>
            <p class="mt-2 text-sm text-gray-500 max-w-3xl">
                åŸ·è¡Œç¯€å¥ï¼šæ˜ŸæœŸä¸€ã€ä¸‰ã€äº”ï¼ˆè·¯ç·š Aï¼‰ï¼›æ˜ŸæœŸäºŒã€å››ã€å…­ï¼ˆè·¯ç·š Bï¼‰ï¼›æ˜ŸæœŸæ—¥ï¼ˆä¼‘è€•ï¼‰ã€‚å®Œç¾è²¼åˆæ‚¨ 07:40ã€08:30ã€12:00ã€18:00 çš„å››å¤§é»ƒé‡‘ç¯€é»ã€‚
            </p>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <section class="mb-8">
            <div class="bg-white rounded-xl shadow-sm p-1 inline-flex w-full md:w-auto border border-gray-200 flex-col md:flex-row gap-1">
                <button id="btn-route-a" onclick="switchRoute('A')" class="flex-1 md:flex-none px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none ring-offset-2 focus:ring-2 ring-emerald-500 text-gray-600 hover:bg-gray-50">
                    <i class="fa-solid fa-leaf"></i> è·¯ç·š A (ä¸€/ä¸‰/äº”)
                </button>
                <button id="btn-route-b" onclick="switchRoute('B')" class="flex-1 md:flex-none px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none ring-offset-2 focus:ring-2 ring-blue-500 text-gray-600 hover:bg-gray-50">
                    <i class="fa-solid fa-shield-virus"></i> è·¯ç·š B (äºŒ/å››/å…­)
                </button>
                <button id="btn-route-c" onclick="switchRoute('C')" class="flex-1 md:flex-none px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none ring-offset-2 focus:ring-2 ring-purple-500 text-gray-600 hover:bg-gray-50">
                    <i class="fa-solid fa-bed"></i> ä¼‘è€•æ—¥ (é€±æ—¥)
                </button>
            </div>
            
            <div class="mt-4 bg-white p-6 rounded-xl border border-gray-100 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-800 mb-2" id="route-title">æˆ°ç•¥ç¸½çµ</h2>
                <p id="route-description" class="text-gray-600 leading-relaxed font-medium"></p>
                <div class="mt-4 flex flex-wrap gap-2" id="route-tags"></div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-7">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fa-regular fa-clock mr-2 text-gray-400"></i> åŸ·è¡Œæ™‚é–“è»¸
                </h3>
                <p class="text-sm text-gray-500 mb-6">ç›®å‰æ™‚æ®µå·²è‡ªå‹•é«˜äº®æ¨™è¨˜ã€‚é»æ“Šä¸‹æ–¹æ™‚é–“é»å¯æŸ¥çœ‹è©³ç´°é¡§å•è§£æèˆ‡ç”ŸåŒ–æ©Ÿè½‰ã€‚</p>
                <div class="relative pl-2" id="timeline-container">
                    <div class="timeline-line"></div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-4">æˆ°ç•¥é›·é”åˆ†æ</h3>
                    <div class="chart-container"><canvas id="radarChart"></canvas></div>
                </div>

                <div id="detail-panel" class="bg-slate-50 border border-slate-200 p-6 rounded-xl shadow-sm transition-all duration-300 opacity-0 transform translate-y-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div id="detail-icon" class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-lg"></div>
                            <div>
                                <h4 id="detail-title" class="font-bold text-gray-800 text-lg"></h4>
                                <span id="detail-time" class="text-xs font-semibold text-gray-500 uppercase tracking-wider"></span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h5 class="text-xs font-bold text-gray-400 uppercase mb-1">æˆ°è¡“æ‘˜è¦</h5>
                            <p id="detail-purpose" class="text-gray-700 text-sm font-medium"></p>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-100 shadow-sm">
                            <h5 class="text-xs font-bold text-indigo-500 uppercase mb-2">
                                <i class="fa-solid fa-user-doctor mr-1"></i>é¡§å•è§£æ
                            </h5>
                            <p id="detail-mechanism" class="text-gray-600 text-sm leading-relaxed"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <section class="mt-12 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">å¿«é€Ÿå°ç…§æ¸…å–®</h3>
                <span class="text-xs text-amber-600 bg-amber-100 px-2 py-1 rounded font-bold"><i class="fa-solid fa-thumbtack mr-1"></i>é»ƒè‰²æ¨™è¨˜ç‚ºç›®å‰æ™‚æ®µ</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ™‚æ®µ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è£œå……å“é …</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // --- Data Definitions ---
        const data = {
            A: {
                id: 'A',
                title: "ğŸ”´ è·¯ç·š Aï¼šã€ä»£è¬å¹²æ“¾èˆ‡é˜²è­·æ—¥ã€‘",
                themeColor: "emerald",
                description: "æˆ°ç•¥ç›®æ¨™ï¼šåˆ‡æ–·è…«ç˜¤èƒ½é‡ (AMPK)ã€æº«å’ŒæŠ‘åˆ¶è¡€ç®¡æ–°ç”Ÿã€ä¿è­·è²§è¡€ã€‚",
                radarData: [95, 60, 85, 80, 50],
                tags: ["AMPK æ¿€æ´»", "è¡€ç®¡æ–°ç”ŸæŠ‘åˆ¶", "è²§è¡€ä¿è­·", "è…¸é“å®šæ®–"],
                steps: [
                    { time: "07:40", condition: "èµ·åºŠç©ºè…¹", item: "1 é¡† ä¹³é…¸èŒ ï¼‹ 1 é¡† ç´…æ™¯å¤©", icon: "fa-sun", purpose: "å®‰å…¨å®šæ®–ä¸¦ææ—©é—œé–‰ HIF-1Î± è­¦å ±å™¨ã€‚", mechanism: "50åˆ†é˜çš„ç©ºè…¹æœŸï¼Œè®“ä¹³é…¸èŒå®‰å…¨æŠµé”è…¸é“å®šæ®–ï¼›æ°´æº¶æ€§çš„ç´…æ™¯å¤©å‰‡å¿«é€Ÿé€²å…¥è¡€æ¶²ï¼Œæ—©ä¸€æ­¥é—œé–‰è…«ç˜¤çš„ç¼ºæ°§è­¦å ±å™¨ (HIF-1Î±)ï¼ŒåŒæ™‚è®“æ‚¨ä¸€æ•´å¤©ç²¾ç¥å¥•å¥•ã€‚", color: "bg-emerald-100 text-emerald-700" },
                    { time: "08:30", condition: "å…¬å¸æ—©é¤ / éš¨é¤", item: "1 é¡† å°æª—é¹¼", icon: "fa-utensils", purpose: "æœƒå¸«ç´…æ™¯å¤©ï¼Œå…±åŒæ´»åŒ– AMPKã€‚", mechanism: "ç¬¬ä¸€å£é£Ÿç‰©ä¸‹è‚šå¾Œåƒå°æª—é¹¼ï¼Œä¸å‚·èƒƒã€‚å®ƒèˆ‡å‰›å‰›çš„ç´…æ™¯å¤©åœ¨é«”å…§ã€Œæœƒå¸«ã€ï¼Œå…±åŒæ´»åŒ– AMPKï¼ˆæ–·é›»å°çµ„è¯æ‰‹ï¼‰ï¼Œå¾¹åº•åˆ‡æ–·è…«ç˜¤èƒ½é‡ã€‚åŒæ™‚ç‚ºæ™šä¸Šçš„è¥¿è—¥çˆ­å–è¿‘ 10 å°æ™‚çš„ä»£è¬æœŸã€‚", color: "bg-emerald-100 text-emerald-700" },
                    { time: "12:00", condition: "å…¬å¸åˆé¤ / é£¯å¾Œ", item: "1 é¡† EGCG (ç¶ èŒ¶èƒå–)", icon: "fa-mug-hot", purpose: "æº«å’ŒæŠ‘åˆ¶è¡€ç®¡æ–°ç”Ÿã€ä¿è­·è²§è¡€ã€‚", mechanism: "é£¯å¾Œåƒé¿é–‹èƒƒç—›èˆ‡è‚æ¯’æ€§ï¼Œæº«å’Œè¯åˆåˆé¤ä¸­å¤šé¤˜çš„éµè³ªï¼Œä¿è­·åœ°ä¸­æµ·å‹è²§è¡€ã€‚", color: "bg-emerald-100 text-emerald-700" },
                    { time: "18:00", condition: "æ™šé¤ / éš¨é¤", item: "1 é¡† Lipanthyl (é™è„‚è¥¿è—¥)", icon: "fa-pills", purpose: "è¥¿è—¥å¸¸è¦æœç”¨ã€‚", mechanism: "è‚è‡Ÿé€šé“å·²æ·¨ç©ºï¼Œå°ˆå¿ƒè™•ç†è¥¿è—¥ã€‚", color: "bg-emerald-50 text-emerald-600 border-emerald-200" }
                ]
            },
            B: {
                id: 'B',
                title: "ğŸ”µ è·¯ç·š Bï¼šã€æŠ—ç¼ºæ°§èˆ‡æŠ—ç™¼ç‚æ—¥ã€‘",
                themeColor: "blue",
                description: "æˆ°ç•¥ç›®æ¨™ï¼šé›™é‡é™è§£ç¼ºæ°§å¼•æ“ (HIF-1Î±)ã€æ’²æ»…å¾®ç’°å¢ƒç™¼ç‚ã€‚(è¨»ï¼šæ˜ŸæœŸå…­è‹¥ä½œæ¯å»¶å¾Œï¼Œè«‹ä¾ã€Œèµ·åºŠç©ºè…¹ â” éš” 50 åˆ†é˜åƒç¬¬ä¸€é¤ã€ç­‰æ¯”ä¾‹é †å»¶)",
                radarData: [50, 95, 85, 60, 95],
                tags: ["HIF-1Î± é™è§£", "æ’²æ»…å¾®ç’°å¢ƒç™¼ç‚", "SIRT1 å•Ÿå‹•", "è¡€ç®¡å½ˆæ€§"],
                steps: [
                    { time: "07:40", condition: "èµ·åºŠç©ºè…¹", item: "1 é¡† ä¹³é…¸èŒ ï¼‹ 1 é¡† ç´…æ™¯å¤©", icon: "fa-sun", purpose: "ç¬¬ä¸€é‡å£“åˆ¶ç¼ºæ°§å¼•æ“ã€‚", mechanism: "åŒæ¨£å…ˆè®“ç´…æ™¯å¤©æ‰“é ­é™£ï¼Œå°è…«ç˜¤çš„ç¼ºæ°§å¼•æ“é€²è¡Œã€Œç¬¬ä¸€é‡å£“åˆ¶ã€ã€‚", color: "bg-blue-100 text-blue-700" },
                    { time: "08:30", condition: "å…¬å¸æ—©é¤ / éš¨é¤", item: "1 é¡† åå­—èŠ±ç§‘ ï¼‹ ç™½è—œè˜†é†‡", icon: "fa-carrot", purpose: "ç¬¬äºŒé‡èˆ‡ç¬¬ä¸‰é‡æ¯€æ»…ï¼Œå®Œç¾é€£æ“Šã€‚", mechanism: "é€™æ˜¯æœ€å®Œç¾çš„é€£æ“Šï¼åå­—èŠ±ç§‘ï¼ˆè˜¿è””ç¡«ç´ ï¼‰èˆ‡ç™½è—œè˜†é†‡é€²å ´ï¼Œå°è…«ç˜¤çš„ç¼ºæ°§å¼•æ“é€²è¡Œã€Œç¬¬äºŒé‡èˆ‡ç¬¬ä¸‰é‡æ¯€æ»…ã€ã€‚ä¸‰ç®¡é½Šä¸‹ï¼ŒæŠŠ HIF-1Î± å£“åˆ¶åˆ°æœ€ä½é»ï¼", color: "bg-blue-100 text-blue-700" },
                    { time: "12:00", condition: "å…¬å¸åˆé¤ / éš¨é¤", item: "1 é¡† Longvida è–‘é»ƒç´ ", icon: "fa-capsules", purpose: "ä¸‹åˆç™¼æ®å¼·å¤§æŠ—ç™¼ç‚èˆ‡æŠ—è¡€ç®¡æ–°ç”Ÿå¨åŠ›ã€‚", mechanism: "è—‰ç”±åˆé¤æ²¹è„‚é”åˆ°æœ€é«˜å¸æ”¶ç‡ï¼Œä¸‹åˆç™¼æ®å¼·å¤§æŠ—ç™¼ç‚èˆ‡æŠ—è¡€ç®¡æ–°ç”Ÿå¨åŠ›ï¼Œä¸”æœ‰ 6 å°æ™‚ä»¥ä¸Šçš„æ™‚é–“è®“è‚è‡Ÿä»£è¬ï¼Œä¸å¡è»Šã€‚", color: "bg-blue-100 text-blue-700" },
                    { time: "18:00", condition: "æ™šé¤ / éš¨é¤", item: "1 é¡† Lipanthyl (é™è„‚è¥¿è—¥)", icon: "fa-pills", purpose: "ç¢ºä¿å¤œé–“æœ€å¤§é™è„‚åŠŸæ•ˆã€‚", mechanism: "ç¢ºä¿è¥¿è—¥åœ¨å¤œé–“ç™¼æ®æœ€å¤§é™è¡€è„‚åŠŸæ•ˆã€‚", color: "bg-blue-50 text-blue-600 border-blue-200" }
                ]
            },
            C: {
                id: 'C',
                title: "ğŸŒ´ æ˜ŸæœŸæ—¥ï¼šã€è‚è‡Ÿè§£æ¯’ä¼‘è€•æ—¥ã€‘",
                themeColor: "purple",
                description: "æˆ°ç•¥ç›®æ¨™ï¼šè®“è‚è‡Ÿä¼‘æ¯ã€é¿å…è…«ç˜¤ç”¢ç”ŸæŠ—è—¥æ€§ã€‚ä»Šæ—¥æš«åœå¤šæ•¸è£œå……å“ï¼Œç‚ºä¸‹é€±æˆ°ç•¥å„²å‚™èƒ½é‡ã€‚",
                radarData: [20, 20, 50, 60, 20],
                tags: ["è‚è‡Ÿä¼‘è€•", "é¿å…æŠ—è—¥æ€§", "å¾®ç’°å¢ƒé‡ç½®"],
                steps: [
                    { time: "07:40", condition: "èµ·åºŠç©ºè…¹", item: "1 é¡† ä¹³é…¸èŒ", icon: "fa-bacteria", purpose: "ç¶­æŒè…¸èƒƒé“å¥åº·ã€‚", mechanism: "åƒ…è£œå……ç›Šç”ŸèŒç¶­æŒåŸºç¤è…¸é“å¾®ç”Ÿæ…‹ï¼Œä¸çµ¦äºˆè‚è‡Ÿä»»ä½•é¡å¤–è§£æ¯’èˆ‡ä»£è¬å£“åŠ›ã€‚", color: "bg-purple-100 text-purple-700" },
                    { time: "08:30", condition: "æ—©é¤", item: "ä¸åƒ ä»»ä½•ä¿é¤Šå“", icon: "fa-mug-saucer", purpose: "è‡Ÿå™¨ä¼‘æ¯æ™‚æ®µã€‚", mechanism: "åˆ»æ„ç•™ç™½ï¼Œè®“ç´°èƒé€šé“é‡ç½®ï¼Œé¿å…èº«é«”ç”¢ç”Ÿé©æ‡‰æ€§æˆ–è…«ç˜¤æŠ—è—¥æ€§ã€‚", color: "bg-gray-100 text-gray-500" },
                    { time: "12:00", condition: "åˆé¤", item: "ä¸åƒ ä»»ä½•ä¿é¤Šå“", icon: "fa-bowl-food", purpose: "è‡Ÿå™¨ä¼‘æ¯æ™‚æ®µã€‚", mechanism: "è®“è‚è‡Ÿæœ‰å……è¶³çš„é»ƒé‡‘æ™‚é–“é€²è¡Œè‡ªé«”ä¿®å¾©èˆ‡æ·±å±¤è§£æ¯’ã€‚", color: "bg-gray-100 text-gray-500" },
                    { time: "18:00", condition: "æ™šé¤ / éš¨é¤", item: "1 é¡† Lipanthyl (é™è„‚è¥¿è—¥)", icon: "fa-pills", purpose: "è¥¿è—¥çµ•å°ä¸èƒ½åœã€‚", mechanism: "ç¶­æŒå¿…é ˆçš„è™•æ–¹è—¥ç‰©æ²»ç™‚ï¼Œåœ¨ç„¡ä»»ä½•ä¿å¥å“å¹²æ“¾çš„å®Œç¾ç’°å¢ƒä¸‹ï¼Œè®“è‚è‡Ÿå–®ç´”ã€å°ˆæ³¨åœ°è™•ç†è¥¿è—¥ã€‚", color: "bg-purple-100 text-purple-700" }
                ]
            }
        };

        const radarLabels = ['èƒ½é‡ä»£è¬èª¿ç¯€ (AMPK)', 'æŠ—ç¼ºæ°§èƒ½åŠ› (HIF-1Î±)', 'è…¸é“å¥åº·', 'è¡€æ¶²/è¡€ç®¡ä¿è­·', 'æŠ—ç™¼ç‚/æŠ—æ°§åŒ–'];

        let defaultRoute = 'A'; 
        let currentRoute = 'A'; 
        let chartInstance = null;

        const els = {
            btnA: document.getElementById('btn-route-a'),
            btnB: document.getElementById('btn-route-b'),
            btnC: document.getElementById('btn-route-c'),
            routeTitle: document.getElementById('route-title'),
            desc: document.getElementById('route-description'),
            tags: document.getElementById('route-tags'),
            timeline: document.getElementById('timeline-container'),
            summaryBody: document.getElementById('summary-table-body'),
            detailPanel: document.getElementById('detail-panel'),
            dIcon: document.getElementById('detail-icon'),
            dTitle: document.getElementById('detail-title'),
            dTime: document.getElementById('detail-time'),
            dPurpose: document.getElementById('detail-purpose'),
            dMech: document.getElementById('detail-mechanism'),
            todayBadge: document.getElementById('today-badge'),
            notifyBtn: document.getElementById('notify-btn')
        };

        // --- æ ¸å¿ƒï¼šçœé›»æ’ç¨‹æ¨æ’­ç³»çµ± (Notification Triggers API) ---
        async function enableSmartNotifications() {
            if (!("Notification" in window)) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½");
                return;
            }

            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert("æ¨æ’­æ¬Šé™å·²è¢«æ‹’çµ•ï¼Œè«‹è‡³ç³»çµ±è¨­å®šä¸­é–‹å•Ÿã€‚");
                return;
            }

            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.ready;
                
                // æ›´æ–°æŒ‰éˆ•å¤–è§€
                els.notifyBtn.innerHTML = `<i class="fa-solid fa-bell-on mr-2"></i>æé†’å·²å•Ÿå‹• (æ¥µçœé›»æ¨¡å¼)`;
                els.notifyBtn.classList.replace('bg-teal-50', 'bg-emerald-100');
                els.notifyBtn.classList.replace('text-teal-700', 'text-emerald-800');

                // è¨»å†Šä»Šæ—¥é¬§é˜
                scheduleTodayAlerts(registration);
                alert("âœ… å·²æˆåŠŸè¨»å†Šç³»çµ±ç´šé¬§é˜ï¼\næ™‚é–“åˆ°å‰ 30 åˆ†é˜ï¼Œå°±ç®—é—œé–‰ App ä¹Ÿæœƒæº–æ™‚æ¨æ’­æé†’ã€‚é€™é …åŠŸèƒ½ç”± Android åº•å±¤æ¥ç®¡ï¼Œä¸æœƒæ¶ˆè€—é¡å¤–é›»åŠ›ã€‚");
            }
        }

        function scheduleTodayAlerts(registration) {
            // ç”±æ–¼å®‰å…¨æ€§èˆ‡æ”¯æ´åº¦ï¼Œæˆ‘å€‘å…ˆæª¢æŸ¥æ˜¯å¦æ”¯æ´ showTrigger (Chrome å¯¦é©—æ€§åŠŸèƒ½/ç¾ä»£ Android æ”¯æ´)
            const supportsTriggers = 'showTrigger' in Notification.prototype;
            
            const routeData = data[defaultRoute];
            const now = new Date();

            routeData.steps.forEach((step, index) => {
                if (step.item.includes("ä¸åƒ")) return;

                const [h, m] = step.time.split(':').map(Number);
                let targetTime = new Date();
                targetTime.setHours(h, m, 0, 0);
                
                // æ‰£é™¤ 30 åˆ†é˜
                targetTime.setMinutes(targetTime.getMinutes() - 30);

                // å¦‚æœé€™å€‹æ™‚é–“åœ¨æœªä¾†ï¼Œæ‰è¨­å®šé¬§é˜
                if (targetTime > now) {
                    if (supportsTriggers) {
                        // ã€æ¥µåº¦çœé›»æ³•ã€‘ï¼šç³»çµ±ç´šæ’ç¨‹
                        registration.showNotification(`æˆ°ç•¥æé†’ï¼šå†é30åˆ†é˜ (${step.time})`, {
                            body: `å³å°‡æœç”¨ï¼š${step.item}\næˆ°è¡“ï¼š${step.purpose}`,
                            icon: 'icon.png',
                            vibrate: [200, 100, 200, 100, 200],
                            tag: `alert-${defaultRoute}-${index}`, // é¿å…é‡è¤‡æ¨æ’­
                            showTrigger: new TimestampTrigger(targetTime.getTime())
                        });
                    } else {
                        // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœç€è¦½å™¨ä¸æ”¯æ´ Trigger APIï¼Œæ”¹ç”¨å‚³çµ± Timeout (å‰ææ˜¯ App æ²’è¢«ç³»çµ±å¼·åˆ¶ç¡çœ )
                        const delay = targetTime.getTime() - now.getTime();
                        setTimeout(() => {
                            registration.showNotification(`æˆ°ç•¥æé†’ï¼šå†é30åˆ†é˜ (${step.time})`, {
                                body: `å³å°‡æœç”¨ï¼š${step.item}\næˆ°è¡“ï¼š${step.purpose}`,
                                icon: 'icon.png',
                                vibrate: [200, 100, 200]
                            });
                        }, delay);
                    }
                }
            });
        }


        // --- æ™‚é–“åˆ¤å®š ---
        function getCurrentStepIndex(steps) {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            let activeIndex = 0;
            for (let i = 0; i < steps.length; i++) {
                const [hours, mins] = steps[i].time.split(':').map(Number);
                const stepMinutes = hours * 60 + mins;
                if (currentMinutes >= stepMinutes) activeIndex = i;
                else break;
            }
            return activeIndex;
        }

        function init() {
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const daysMap = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            
            if (dayOfWeek === 0) defaultRoute = 'C';
            else if ([1, 3, 5].includes(dayOfWeek)) defaultRoute = 'A';
            else defaultRoute = 'B';
            currentRoute = defaultRoute;

            els.todayBadge.innerHTML = `<i class="fa-regular fa-calendar-check mr-2"></i>ä»Šå¤©ç‚º${daysMap[dayOfWeek]}ï¼Œé è¨­è¼‰å…¥è·¯ç·š ${currentRoute}`;

            // è‹¥å·²æˆæ¬Šï¼Œè‡ªå‹•è®Šæ›´æŒ‰éˆ•å¤–è§€
            if (Notification.permission === 'granted') {
                els.notifyBtn.innerHTML = `<i class="fa-solid fa-bell mr-2"></i>æé†’å·²å•Ÿå‹• (æ¥µçœé›»æ¨¡å¼)`;
                els.notifyBtn.classList.replace('bg-teal-50', 'bg-emerald-100');
                els.notifyBtn.classList.replace('text-teal-700', 'text-emerald-800');
                // æ¯æ¬¡æ‰“é–‹ App æ™‚è‡ªå‹•æ›´æ–°ä¸€æ¬¡é¬§é˜
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(reg => scheduleTodayAlerts(reg));
                }
            }

            renderRoute(currentRoute);
        }

        function switchRoute(routeId) {
            if (currentRoute === routeId) return;
            currentRoute = routeId;
            renderRoute(routeId);
        }

        function renderRoute(routeId) {
            const routeData = data[routeId];
            const btns = [
                { id: 'A', el: els.btnA, colorClass: 'emerald' },
                { id: 'B', el: els.btnB, colorClass: 'blue' },
                { id: 'C', el: els.btnC, colorClass: 'purple' }
            ];

            btns.forEach(btnInfo => {
                if (btnInfo.id === routeId) {
                    btnInfo.el.className = `flex-1 md:flex-none px-6 py-3 rounded-lg text-sm font-bold shadow-md transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none ring-offset-2 focus:ring-2 ring-${btnInfo.colorClass}-500 bg-${btnInfo.colorClass}-600 text-white`;
                } else {
                    btnInfo.el.className = `flex-1 md:flex-none px-6 py-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 focus:outline-none ring-offset-2 focus:ring-2 ring-gray-300 text-gray-600 hover:bg-gray-100 bg-white border border-gray-200`;
                }
            });

            els.routeTitle.textContent = routeData.title;
            els.desc.textContent = routeData.description;
            els.tags.innerHTML = routeData.tags.map(tag => `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${routeData.themeColor}-100 text-${routeData.themeColor}-800">#${tag}</span>`).join('');

            updateChart(routeData);
            renderTimeline(routeData);
            renderTable(routeData);

            const isTodayRoute = (routeId === defaultRoute);
            const startIdx = isTodayRoute ? getCurrentStepIndex(routeData.steps) : 0;
            showDetails(routeData.steps[startIdx], startIdx);
        }

        function renderTimeline(routeData) {
            const line = els.timeline.querySelector('.timeline-line');
            els.timeline.innerHTML = '';
            els.timeline.appendChild(line);

            const isTodayRoute = (routeData.id === defaultRoute);
            const currentStepIdx = getCurrentStepIndex(routeData.steps);

            routeData.steps.forEach((step, index) => {
                const isCurrentNow = isTodayRoute && (index === currentStepIdx);
                const stepEl = document.createElement('div');
                stepEl.className = `step-card relative pl-10 py-2 mb-4 cursor-pointer group`;
                stepEl.onclick = () => showDetails(step, index);

                const dotColor = isCurrentNow ? 'bg-amber-500' : `bg-${routeData.themeColor}-500`;
                const dotPulse = isCurrentNow ? `<div class="absolute left-[20px] top-6 w-3 h-3 rounded-full bg-amber-400 animate-ping transform -translate-x-1/2 z-0"></div>` : '';
                const cardStyle = isCurrentNow ? `bg-amber-50 p-4 rounded-lg border-2 border-amber-400 shadow-md` : `bg-white p-4 rounded-lg border border-gray-100 shadow-sm group-hover:border-${routeData.themeColor}-300`;
                const nowBadge = isCurrentNow ? `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-amber-500 text-white shadow-sm animate-pulse"><i class="fa-solid fa-thumbtack mr-1"></i>ç›®å‰æ™‚æ®µ</span>` : '';
                const timeColor = isCurrentNow ? 'text-amber-700' : 'text-gray-400';

                stepEl.innerHTML = `
                    ${dotPulse}
                    <div class="absolute left-[20px] top-6 w-3 h-3 rounded-full ${dotColor} border-2 border-white shadow transform -translate-x-1/2 z-10 transition-transform group-hover:scale-125"></div>
                    <div class="${cardStyle} transition-colors step-card-content" id="step-card-${index}">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-xs font-bold ${timeColor} uppercase tracking-wide">${step.time}${nowBadge}</span>
                                <h4 class="text-md font-bold text-gray-800 mt-1">${step.item}</h4>
                            </div>
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${step.color}">
                                ${step.condition}
                            </span>
                        </div>
                    </div>
                `;
                els.timeline.appendChild(stepEl);
            });
        }

        function showDetails(step, index) {
            const isTodayRoute = (currentRoute === defaultRoute);
            const currentStepIdx = getCurrentStepIndex(data[currentRoute].steps);
            
            document.querySelectorAll('.step-card-content').forEach((el, i) => {
                el.classList.remove('ring-2', 'ring-emerald-400', 'ring-blue-400', 'ring-purple-400', 'ring-amber-400');
                if (i === index) {
                    const isCurrentNow = isTodayRoute && (index === currentStepIdx);
                    const ringColor = isCurrentNow ? 'ring-amber-400' : `ring-${data[currentRoute].themeColor}-400`;
                    el.classList.add('ring-2', ringColor);
                }
            });

            els.detailPanel.classList.remove('opacity-0', 'translate-y-4');
            els.detailPanel.classList.add('opacity-100', 'translate-y-0');

            const themeText = `text-${data[currentRoute].themeColor}-600`;
            els.dIcon.innerHTML = `<i class="fa-solid ${step.icon} ${themeText}"></i>`;
            els.dTitle.textContent = step.item;
            els.dTime.textContent = `${step.time} â€¢ ${step.condition}`;
            els.dPurpose.textContent = step.purpose;
            els.dMech.textContent = step.mechanism;
        }

        function renderTable(routeData) {
            const isTodayRoute = (routeData.id === defaultRoute);
            const currentStepIdx = getCurrentStepIndex(routeData.steps);

            els.summaryBody.innerHTML = routeData.steps.map((step, index) => {
                const isCurrentNow = isTodayRoute && (index === currentStepIdx);
                const trClass = isCurrentNow ? 'bg-amber-50 border-l-4 border-amber-500' : 'hover:bg-gray-50 transition-colors border-l-4 border-transparent';
                const timeDisplay = isCurrentNow
                    ? `<span class="font-bold text-amber-700">${step.time}</span> <span class="ml-1 px-1.5 py-0.5 bg-amber-500 text-white text-[10px] rounded font-bold animate-pulse">NOW</span>`
                    : step.time;

                return `
                    <tr class="${trClass}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${timeDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${step.color}">${step.condition}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${step.item}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateChart(routeData) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            let color;
            if (routeData.id === 'A') color = '16, 185, 129';
            else if (routeData.id === 'B') color = '59, 130, 246';
            else color = '168, 85, 247';

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: radarLabels,
                    datasets: [{
                        label: routeData.title,
                        data: routeData.radarData,
                        fill: true,
                        backgroundColor: `rgba(${color}, 0.2)`,
                        borderColor: `rgba(${color}, 1)`,
                        pointBackgroundColor: `rgba(${color}, 1)`,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: `rgba(${color}, 1)`
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: '#f3f4f6' },
                            grid: { color: '#e5e7eb' },
                            pointLabels: { font: { size: 11, family: "'Noto Sans TC', sans-serif" }, color: '#6b7280' },
                            suggestedMin: 0, suggestedMax: 100,
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>